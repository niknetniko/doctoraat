%! suppress = Makeatletter
%! Author = niko
%! Date = 5/10/2023

% Preamble
\documentclass[
    paper=240mm:170mm,
    paper=portrait,
    parskip=half,
    cleardoublepage=plain,
    toc=chapterentrywithdots,
    chapterprefix=true,
    captions=tableheading,
    fontsize=10pt,
    mpinclude=true,
    DIV=13,
    BCOR=10mm
]{scrbook}

% Het formaat van een doctoraat is "proefschrift B5".
% Een lichte afwijking tegenover ISO B5. B5 = 176x250mm
% Wij gebruiken 170x240mm.
%\usepackage[paperheight=240mm,paperwidth=170mm,heightrounded,showframe]{geometry}
% We want more margins for our notes.
\addtolength{\marginparwidth}{1.5cm}

\usepackage{standalone}

% Andere
%\usepackage{showframe}
\usepackage{xcolor}
\usepackage{circledsteps}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{luacode}
\directlua{pdf.setminorversion(7)}
\usepackage[inline]{enumitem}

% We want modern numbers here
\renewcommand{\CircledText}[2][]{%
    \CircledParamOpts{inner color=none, outer color=none, #1}{1}{\liningnums{#2}}%
}

\renewcommand{\dictumwidth}{0.75\textwidth}
\setkomafont{dictum}{\rmfamily}
\setkomafont{dictumauthor}{\rmfamily\small}
\renewcommand*{\dictumauthorformat}[1]{#1}

\usepackage{fontspec}
\setmainfont{Source Serif 4}[
    Renderer = OpenType,
    SizeFeatures    = {%
        {Size={-9},Font=* Caption},
        {Size={9-13},Font=*},
        {Size={14-24},Font=* Subhead},
        {Size={24-},Font=* Display}
    },
    ItalicFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Italic},
            {Size={9-13},Font=* Italic},
            {Size={14-24},Font=* Subhead Italic},
            {Size={24-},Font=* Display Italic}
        },
    },
    BoldFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Semibold},
            {Size={9-13},Font=* Semibold},
            {Size={14-24},Font=* Subhead Semibold},
            {Size={24-},Font=* Display Semibold}
        },
    },
    BoldItalicFeatures = {%
        SizeFeatures    = {%
                {Size={-9},Font=* Caption Semibold Italic},
                {Size={9-13},Font=* Semibold Italic},
                {Size={14-24},Font=* Subhead Semibold Italic},
                {Size={24-},Font=* Display Semibold Italic}
        },
    },
    Numbers         = OldStyle,
]
\setsansfont{Source Sans 3}[
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
\setmonofont{Source Code Pro}[
    Scale          = MatchLowercase,
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
% Have a math font that at least works with our choices.
%\usepackage{unicode-math}
%\setmathfont{Erewhon Math}

% Use real upper and lower scripts.
\usepackage{realscripts}

\usepackage{scrlayer-scrpage}
\usepackage{scrlayer-notecolumn}
\addtokomafont{notecolumn.marginpar}{\footnotesize\raggedright}
\newcommand*{\marginnote}{\makenote}
\makeatletter
\ModifyLayer[
    contents = {%
    \textheight = 2\textheight%
    \slnc@processnotes{marginpar}%
    }
]{notecolumn.marginpar}
\makeatother
\renewcommand*{\captionformat}{~}
\setkomafont{captionlabel}{\small\bfseries}
\setkomafont{caption}{\small}
\setcapindent{1em}

\usepackage{subfiles}

%\usepackage[newfloat,outputdir=\subfix{../out/}]{minted}
% Load minted but listen to the output-directory environment
\begin{luacode*}
    function parseargv()
      local rep = {}
      for k, x in pairs(arg) do
          local kw, vw = string.match(x, "([^=]+)=?([^=]*)")
          rep[kw] = vw
      end
      return rep
    end
    local arguments = parseargv()
    local outputdir = arguments["-output-directory"]
    if outputdir ~= nil then
      tex.print([[\PassOptionsToPackage{outputdir=]] .. outputdir .. [[}{minted}]])
    end
\end{luacode*}
\usepackage[newfloat]{minted}
\setminted{autogobble=true,linenos=true,breaklines=true,fontsize=\footnotesize}
\setmintedinline{fontsize=,}
\usepackage{luacolor}
\usepackage[soul]{lua-ul}
\LuaULSetHighLightColor{ugent-we!20!white}

\usepackage{polyglossia}
\setdefaultlanguage[variant=british]{english}
\setotherlanguages{dutch}

\usepackage[
    autocite=inline,
    style=authoryear-comp,
    maxbibnames=20,
    maxcitenames=2,
    sortcites=true,
    giveninits=true,
    uniquename=init,
    dashed=false,
]{biblatex}
% TODO: why is babelo without authors?
\addbibresource{main.bib}
% Smaller font for bibliography
\renewcommand*{\bibfont}{\normalfont\small}
\AtEveryBibitem{\clearfield{day}}

% From version 3.20, which we do not have yet (thanks texlive)
\DeclareSortingTemplate{dnt}{
    \sort{
        \field{presort}
    }
    \sort[final]{
        \field{sortkey}
    }
    \sort{
        \field{sortyear}
        \field{year}
        \literal{9999}
    }
    \sort{
        \field{month}
    }
    \sort{
        \field{day}
    }
    \sort{
        \field{hour}
    }
    \sort{
        \field{minute}
    }
    \sort{
        \field{second}
    }
    \sort{
        \field{sortname}
        \field{author}
        \field{editor}
        \field{translator}
        \field{sorttitle}
        \field{title}
    }
    \sort{
        \field{sorttitle}
        \field{title}
    }
}

\usepackage{microtype}

\usepackage{siunitx}
\sisetup{detect-all}
\DeclareSIUnit{\fps}{fps}
\usepackage{varwidth}

% Voorblad
\usepackage[type=report]{ugent2016-title}
% TODO: fix UGent 2016
%! suppress = DiscouragedUseOfDef
\let\wordcount\undefined



% Figuren
\input{tikz-preamble}
\usepackage{scratch31}
\usepackage{menukeys}
% Use the styles I want
\renewmenumacro{\keys}{shadowedroundedkeys}
\changemenucolortheme{shadowedroundedkeys}{blacknwhite}
\usepackage{xparse}
\NewDocumentCommand\scratchinline{m}{%
    \begin{scratch}[scale=0.4,baseline=c]%
        #1
    \end{scratch}%
}

%\usepackage[nospace]{varioref}
\usepackage[colorlinks,pdfusetitle,allcolors=ugent-we-dark]{hyperref}
\usepackage[noabbrev]{cleveref}

% Fix bug for cleveref
\makeatletter
\providecommand\english@loaded{}
\providecommand\dutch@loaded{}
\makeatother

\author{Niko Strijbol}
\title{Educational software testing\\for textual and block-based programming languages}
\academicyear{2023 â€“ 2024}
\titletext{A dissertation submitted to Ghent University in partial fulfilment of the requirements for the degree of\\Doctor of Computer Science.}
\promotors{%
Supervisors:\\
Prof.\ Dr.\ Peter Dawyndt\\
Prof.\ Dr.\ Christophe Scholliers\\
Prof.\ Dr.\ Ir.\ Bart Mesuere
}

% Allow small caps from upper case letters
\DeclareRobustCommand\csc{\addfontfeature{Letters=UppercaseSmallCaps}}
\DeclareTextFontCommand{\textcsc}{\csc}

% Automagically convert 'Tested' to smallcaps.
\begin{luacode}
  to_replace = {
    {"TESTed", "\\textsc{test}ed"},
    "JSON",
    "YAML",
    "DSL",
    "API",
    "SVG",
    "NDJSON",
    "MIT",
    "GIL",
    "ABC",
    "ASCII",
    "IDE",
    "GUI",
    "FPS",
    "HTML",
    "CSS",
    "FTRPRF",
    "TIOBE",
    "SPOJ",
    "ACM-ICPC",
    "SQL",
    "ACM",
    "ICPC",
    "OSSL"
  }
  function capstosc(s)
    for _, needle in ipairs(to_replace) do
      if (type(needle) == "table") then
        replacement = needle[2]
        needle = needle[1]
      else
        replacement = "\\textsc{" .. string.lower(needle) .. "}"
      end
      pattern = "%f[%w_]" .. needle .. "%f[^%w_]"
      s = string.gsub(s, pattern, replacement)
    end
    return s
  end
\end{luacode}
\AtBeginDocument{%
\directlua{luatexbase.add_to_callback ("process_input_buffer", capstosc, "capstosc" )}
}

\newcommand{\requ}[1]{\textcsc{(RQ#1)}}

\newenvironment{wide}{%
    \begin{addmargin*}[0cm]{-\dimexpr\marginparwidth+\marginparsep\relax}%
    \Ifthispageodd{\raggedright}{\raggedleft}%
    }{%
    \end{addmargin*}
}

\DeclareTOCStyleEntry[%
    level=\parttocdepth,
    indent=0pt,
    numwidth=0pt,
    beforeskip=.25em,
    entryformat=\nullfont,
    entrynumberformat=\nullfont,
    linefill=\relax,
    pagenumberformat=\nullfont,
]{part}{dummypart}
\newcommand*{\dummypart}{%
    \clearpage
    \addxcontentsline{toc}{dummypart}{}%
    \bookmarksetup{startatroot}
}

% Allow using TESTed as is, without small caps replacement.
\newcommand{\tested}{TESTed}
\newcommand{\dsl}{DSL}
\newcommand{\json}{JSON}
\newcommand{\yaml}{YAML}
\newcommand{\api}{API}

\newcommand{\software}[1]{\textit{#1}}
\newcommand{\term}[1]{\index{#1}\textbf{#1}}

\begin{document}

% The order of the frontmatter is determined by Hart's rules in addition to Wikipedia.
% The order is: titlepage, colofon, abstracts (summary), acknowledgement, tables (toc, list of ...)
\frontmatter

% We want Panno on the complete front page.
{
    \selectfont\panno
    \maketitle
}

\subfile{colophon}

\subfile{summary-nl.nltex}
\subfile{summary-en}

\subfile{dankwoord.nltex}

\tableofcontents

\addchap{List of publications}

%! suppress = NonBreakingSpace
\begin{refcontext}[sorting=dnt]
    %! suppress = NonMatchingIf
    \renewcommand*{\mkbibcompletename}[1]{\ifitemannotation{me}{\textbf{#1}}{#1}}
    \nocite{strijbolBlinkEducationalSoftware2023,strijbolBlinkEducationalSoftware2024,strijbolTESTedDSLDomainspecificLanguage2024,strijbolTESTedEducationalTesting2023,vanpetegemDodonaLearnCode2023,vanpetegemPassFailPrediction2023,maertensDiscoveringExploringCases2024,maertensDolosLanguageagnosticPlagiarism2022}
    \renewcommand*{\bibfont}{\normalfont\normalsize}
    \setlength{\bibitemsep}{\itemsep}
    % This is very ugly and will probably break.
    % https://tex.stackexchange.com/questions/360781/change-giveninits-option-within-document-biblatex
    \togglefalse{abx@bool@giveninits}
    \DeclareNameAlias{author}{given-family}
    \printbibliography[keyword={mine},heading=none]
\end{refcontext}

\mainmatter

\subfile{introduction/introduction.tex}

\part{\tested{}}\label{part:tested}
%\subfile{tested-glue.tex}
\subfile{tested-engine/engine.tex}
\subfile{tested-dsl/dsl.tex}

\part{Scratch}\label{part:scratch}
%\subfile{itch-glue.tex}
\subfile{scratch-introduction/scratch-introduction.tex}
\subfile{scratch-itch/itch.tex}
\subfile{scratch-blink/blink.tex}
\subfile{scratch-execution-model/execution-model.tex}

\dummypart
\subfile{conclusion.tex}

% Allow a wide bibliography
\clearpage
\storeareas\StandardArea
\addtolength{\marginparwidth}{-1.5cm}
\KOMAoptions{mpinclude=false}
\recalctypearea
\printbibliography[heading=bibintoc]
\clearpage
\StandardArea

\appendix

\subfile{appendix-vpw/vpw.tex}

\end{document}
