%! Author = niko
%! Date = 5/10/2023

% Preamble
\documentclass[
    paper=240mm:170mm,
    paper=portrait,
    parskip=half,
    cleardoublepage=plain,
    toc=chapterentrywithdots,
    chapterprefix=true,
    captions=tableheading,
%    fontsize=10pt,
    mpinclude=true,
    DIV=13,
    BCOR=10mm
]{scrbook}

% Het formaat van een doctoraat is "proefschrift B5".
% Een lichte afwijking tegenover ISO B5. B5 = 176x250mm
% Wij gebruiken 170x240mm.
%\usepackage[paperheight=240mm,paperwidth=170mm,heightrounded,showframe]{geometry}
% We want more margins for our notes.
\addtolength{\marginparwidth}{1.5cm}

\usepackage{standalone}

% Andere
% \usepackage{showframe}
\usepackage{xcolor}
\usepackage{circledsteps}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{luacode}
\directlua{pdf.setminorversion(7)}
\usepackage[inline]{enumitem}

% We want modern numbers here
\renewcommand{\CircledText}[2][]{%
    \CircledParamOpts{inner color=none, outer color=none, #1}{1}{\liningnums{#2}}%
}

\renewcommand{\dictumwidth}{0.75\textwidth}
\setkomafont{dictum}{\rmfamily\small}
\setkomafont{dictumauthor}{\rmfamily\footnotesize}
\renewcommand*{\dictumauthorformat}[1]{#1}

\usepackage{fontspec}
\setmainfont{Source Serif 4}[
    Renderer = OpenType,
    SizeFeatures    = {%
        {Size={-9},Font=* Caption},
        {Size={9-13},Font=*},
        {Size={14-24},Font=* Subhead},
        {Size={24-},Font=* Display}
    },
    ItalicFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Italic},
            {Size={9-13},Font=* Italic},
            {Size={14-24},Font=* Subhead Italic},
            {Size={24-},Font=* Display Italic}
        },
    },
    BoldFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Semibold},
            {Size={9-13},Font=* Semibold},
            {Size={14-24},Font=* Subhead Semibold},
            {Size={24-},Font=* Display Semibold}
        },
    },
    BoldItalicFeatures = {%
        SizeFeatures    = {%
                {Size={-9},Font=* Caption Semibold Italic},
                {Size={9-13},Font=* Semibold Italic},
                {Size={14-24},Font=* Subhead Semibold Italic},
                {Size={24-},Font=* Display Semibold Italic}
        },
    },
    Numbers         = OldStyle,
]
\setsansfont{Source Sans 3}[
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
\setmonofont{Source Code Pro}[
    Scale          = MatchLowercase,
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
% Have a math font that at least works with our choices.
\usepackage{unicode-math}
\setmathfont{Erewhon Math}

\usepackage{scrlayer-scrpage}
\usepackage{scrlayer-notecolumn}
\addtokomafont{notecolumn.marginpar}{\footnotesize\raggedright}
\newcommand*{\marginnote}{\makenote}
\renewcommand*{\captionformat}{~}
\setkomafont{captionlabel}{\small\bfseries}
\setkomafont{caption}{\small}
\setcapindent{1em}

\usepackage{subfiles}

%\usepackage[newfloat,outputdir=\subfix{../out/}]{minted}
% Load minted but listen to the output-directory environment
\begin{luacode*}
    function parseargv()
      local rep = {}
      for k, x in pairs(arg) do
          local kw, vw = string.match(x, "([^=]+)=?([^=]*)")
          rep[kw] = vw
      end
      return rep
    end
    local arguments = parseargv()
    local outputdir = arguments["-output-directory"]
    if outputdir ~= nil then
      tex.print([[\PassOptionsToPackage{outputdir=]] .. outputdir .. [[}{minted}]])
    end
\end{luacode*}
\usepackage[newfloat]{minted}
\setminted{autogobble=true,linenos=true,breaklines=true,fontsize=\footnotesize}
\setmintedinline{fontsize=,}
\usepackage{luacolor}
\usepackage[soul]{lua-ul}
\LuaULSetHighLightColor{ugent-we!20!white}

\usepackage{polyglossia}
\setdefaultlanguage[variant=british]{english}
\setotherlanguages{dutch,latin}

\usepackage[autocite=inline]{biblatex}
\addbibresource{main.bib}
% Smaller font for bibliography
\renewcommand*{\bibfont}{\normalfont\small}

\usepackage{microtype}

\usepackage{siunitx}
\sisetup{detect-all}


% Voorblad
\usepackage[type=report]{ugent2016-title}

\usepackage[nospace]{varioref}
\usepackage[colorlinks,pdfusetitle]{hyperref}
\usepackage{cleveref}

% Figuren
\input{tikz-preamble}
\usepackage{scratch31}

\usepackage{xparse}
\NewDocumentCommand\scratchinline{m}{%
    \begin{scratch}[scale=0.4,baseline=c]%
        #1
    \end{scratch}%
}

\author{Niko Strijbol}
\title{De Instrumentis Ad Programmaturam Computatralem Discendam}
\subtitle{On Instruments for Learning Computer Programming}
\academicyear{2023 â€“ 2024}
\titletext{%
%A dissertation submitted to Ghent University in partial fulfilment of the requirements for the degree of Doctor of Computer Science.
    \textlatin{\selectfont\panno Dissertatio ad Universitatem Gandavensem partialiter completa ad gradum Doctoris Scientiarum Computatrorum adipiscendum}
}
\promotors{%
%Supervisors:\\
Promotores:\\
Prof.\ Dr.\ Peter Dawyndt\\
Prof.\ Dr.\ Christophe Scholliers\\
Prof.\ Dr.\ Ir.\ Bart Mesuere
}

% Automagically convert 'Tested' to smallcaps.
\begin{luacode}
  function capstosc(s)
    s = string.gsub(s, "%f[%w_]TESTed%f[^%w_]", "\\textsc{test}ed")
    s = string.gsub(s, "%f[%w_]JSON%f[^%w_]", "\\textsc{json}")
    s = string.gsub(s, "%f[%w_]DSL%f[^%w_]", "\\textsc{dsl}")
    s = string.gsub(s, "%f[%w_]YAML%f[^%w_]", "\\textsc{yaml}")
    s = string.gsub(s, "%f[%w_]API%f[^%w_]", "\\textsc{api}")
    s = string.gsub(s, "%f[%w_]SVG%f[^%w_]", "\\textsc{svg}")
    s = string.gsub(s, "%f[%w_]NDJSON%f[^%w_]", "\\textsc{ndjson}")
    s = string.gsub(s, "%f[%w_]MIT%f[^%w_]", "\\textsc{mit}")
    s = string.gsub(s, "%f[%w_]GIL%f[^%w_]", "\\textsc{gil}")
    s = string.gsub(s, "%f[%w_]ABC%f[^%w_]", "\\textsc{abc}")
    s = string.gsub(s, "%f[%w_]ASCII%f[^%w_]", "\\textsc{ascii}")
    s = string.gsub(s, "%f[%w_]IDE%f[^%w_]", "\\textsc{ide}")
    s = string.gsub(s, "%f[%w_]GUI%f[^%w_]", "\\textsc{gui}")
    s = string.gsub(s, "%f[%w_]FPS%f[^%w_]", "\\textsc{fps}")
    s = string.gsub(s, "%f[%w_]HTML%f[^%w_]", "\\textsc{html}")
    s = string.gsub(s, "%f[%w_]CSS%f[^%w_]", "\\textsc{css}")
    s = string.gsub(s, "%f[%w_]FTRPRF%f[^%w_]", "\\textsc{ftrprf}")
    s = string.gsub(s, "%f[%w_]TIOBE%f[^%w_]", "\\textsc{tiobe}")
    return s
  end
\end{luacode}
\AtBeginDocument{%
\directlua{luatexbase.add_to_callback ("process_input_buffer", capstosc, "capstosc" )}
}

\newenvironment{wide}{%
    \begin{addmargin*}[0cm]{-\dimexpr\marginparwidth+\marginparsep\relax}%
    \Ifthispageodd{\raggedright}{\raggedleft}%
    }{%
    \end{addmargin*}
}

% Allow using TESTed as is, without small caps replacement.
\newcommand{\tested}{TESTed}
\newcommand{\dsl}{DSL}
\newcommand{\json}{JSON}
\newcommand{\yaml}{YAML}
\newcommand{\api}{API}

\newcommand{\software}[1]{\textit{#1}}
\newcommand{\term}[1]{\index{#1}\textbf{#1}}

\begin{document}

\frontmatter

% We want Panno on the complete front page.
{
    \selectfont\panno
    \maketitle
}

\subfile{colophon}

\tableofcontents

\subfile{preface}
\subfile{summary-nl}
\subfile{summary-en}

\mainmatter

\part{\tested{}}\label{part:tested}
\subfile{tested-glue.tex}
\subfile{tested-engine/engine.tex}
\subfile{tested-dsl/dsl.tex}

\part{Scratch}\label{part:scratch}
\subfile{itch-glue.tex}
\subfile{scratch-introduction/scratch-introduction.tex}
\subfile{scratch-itch/itch.tex}
\subfile{scratch-blink/blink.tex}
\subfile{scratch-execution-model/execution-model.tex}

\printbibliography[heading=bibintoc]

\end{document}
