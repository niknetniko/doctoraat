%! Author = niko
%! Date = 5/10/2023

% Preamble
\documentclass[
    paper=240mm:170mm,
    paper=portrait,
    parskip=half,
    cleardoublepage=plain,
    toc=chapterentrywithdots,
    chapterprefix=true,
%    fontsize=10pt,
    mpinclude=true,
    DIV=13,
    BCOR=10mm
]{scrbook}

% Het formaat van een doctoraat is "proefschrift B5".
% Een lichte afwijking tegenover ISO B5. B5 = 176x250mm
% Wij gebruiken 170x240mm.
%\usepackage[paperheight=240mm,paperwidth=170mm,heightrounded,showframe]{geometry}
% We want more margins for our notes.
\addtolength{\marginparwidth}{1.5cm}

\usepackage{standalone}

% Andere
\usepackage{lipsum}
%\usepackage{showframe}
\usepackage{xcolor}
\usepackage{circledsteps}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{luacode}
\usepackage{csquotes}
\usepackage[inline]{enumitem}

% We want modern numbers here
\renewcommand{\CircledText}[2][]{%
    \CircledParamOpts{inner color=none, outer color=none, #1}{1}{\liningnums{#2}}%
}

\renewcommand{\dictumwidth}{0.80\textwidth}
\setkomafont{dictum}{\rmfamily\itshape}
\setkomafont{dictumauthor}{\upshape}
\usepackage[style=long]{glossaries}
\setacronymstyle{long-sc-short}

\usepackage{fontspec}
\setmainfont{Source Serif 4}[
    Renderer = OpenType,
    SizeFeatures    = {%
        {Size={-9},Font=* Caption},
        {Size={9-13},Font=*},
        {Size={14-24},Font=* Subhead},
        {Size={24-},Font=* Display}
    },
    ItalicFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Italic},
            {Size={9-13},Font=* Italic},
            {Size={14-24},Font=* Subhead Italic},
            {Size={24-},Font=* Display Italic}
        },
    },
    BoldFeatures = {%
        SizeFeatures    = {%
            {Size={-9},Font=* Caption Semibold},
            {Size={9-13},Font=* Semibold},
            {Size={14-24},Font=* Subhead Semibold},
            {Size={24-},Font=* Display Semibold}
        },
    },
    BoldItalicFeatures = {%
        SizeFeatures    = {%
                {Size={-9},Font=* Caption Semibold Italic},
                {Size={9-13},Font=* Semibold Italic},
                {Size={14-24},Font=* Subhead Semibold Italic},
                {Size={24-},Font=* Display Semibold Italic}
        },
    },
    Numbers         = OldStyle,
]
\setsansfont{Source Sans 3}[
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
\setmonofont{Source Code Pro}[
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]

\usepackage{layouts}
\usepackage{scrlayer-scrpage}
\usepackage{scrlayer-notecolumn}
\addtokomafont{notecolumn.marginpar}{\itshape\footnotesize\raggedright}
\newcommand*{\marginnote}{\makenote}
\setkomafont{captionlabel}{\small\bfseries}
\setkomafont{caption}{\small}

\usepackage{subfiles}

%\usepackage[newfloat,outputdir=\subfix{../out/}]{minted}
% Load minted but listen to the output-directory environment
\begin{luacode*}
    function parseargv()
      local rep = {}
      for k, x in pairs(arg) do
          local kw, vw = string.match(x, "([^=]+)=?([^=]*)")
          rep[kw] = vw
      end
      return rep
    end
    local arguments = parseargv()
    local outputdir = arguments["-output-directory"]
    if outputdir ~= nil then
      tex.print([[\PassOptionsToPackage{outputdir=]] .. outputdir .. [[}{minted}]])
    end
\end{luacode*}
\usepackage[newfloat]{minted}
\setminted{autogobble=true,linenos=true,breaklines=true}

% Lettertypes
\usepackage{microtype}
\usepackage[colorlinks,pdfusetitle]{hyperref}
\usepackage{cleveref}

% Taalinstellingen. Door de verengelsing is de standaardtaal van dit document Engels.
\usepackage{polyglossia}
\usepackage{biblatex}
\addbibresource{main.bib}

% Voorblad
\usepackage[type=report]{ugent2016-title}

\newcommand{\todo}[1]{\textcolor{orange}{\textsc{Todo}: #1}}

% Figuren
\include{tikz-preamble}

% Taalinstellingen.
\setdefaultlanguage[variant=british]{english}
\setotherlanguages{latin,dutch,french}

\usepackage[type=report]{ugent2016-title}
\author{Niko Strijbol}
\title{De Technologiae in Curabitur Aliquet Ultricies}
\subtitle{Quaedam loca debugging et aestimationes}
\academicyear{2023 â€“ 2024}
\titletext{%
A dissertation submitted to Ghent University in partial fulfilment of the requirements for the degree of Doctor of Computer Science.
}
\promotors{%
Supervisors:\\
Prof.\ Dr.\ Peter Dawyndt\\
Prof.\ Dr.\ Christophe Scholliers\\
Prof.\ Dr.\ Ir.\ Bart Mesuere
}

% Automagically convert 'Tested' to smallcaps.
\begin{luacode}
  function capstosc(s)
    s = string.gsub(s, "%f[%w_]TESTed%f[^%w_]", "\\textsc{Test}ed")
    s = string.gsub(s, "%f[%w_]JSON%f[^%w_]", "\\textsc{json}")
    s = string.gsub(s, "%f[%w_]DSL%f[^%w_]", "\\textsc{dsl}")
    s = string.gsub(s, "%f[%w_]YAML%f[^%w_]", "\\textsc{yaml}")
    return s
  end
\end{luacode}
\AtBeginDocument{%
\directlua{luatexbase.add_to_callback ("process_input_buffer", capstosc, "capstosc" )}
}

\newcommand{\widefloat}[1]{%
    \noindent\mbox{%
        \Ifthispageodd{\hspace*{\marginparwidth+\marginparsep}}{\hspace*{-\marginparwidth-\marginparsep}}%
        \begin{minipage}{\textwidth+\marginparwidth+\marginparsep}%
            \Ifthispageodd{\raggedright}{\raggedleft}%
            \noindent#1%
        \end{minipage}%
    }%
}

% Allow using TESTed as is, without small caps replacement.
\newcommand{\tested}{TESTed}
\newcommand{\dsl}{DSL}
\newcommand{\json}{JSON}
\newcommand{\yaml}{YAML}

% Document
\begin{document}

\frontmatter

% We want Panno on the complete front page.
{
    \selectfont\panno
    \maketitle
}

\subfile{colophon}

\tableofcontents

\subfile{preface}
\subfile{summary-nl}
\subfile{summary-en}

\mainmatter

%\subfile{tested-chapter1}

\part{TESTed}\label{part:tested}

\subfile{tested-chapter3/chapter3.tex}
%\subfile{tested-chapter1/tested-chapter1.tex}

%\subfile{chapter5}


%\bibliography{main}
%\bibliographystyle{plain}
\printbibliography[heading=bibintoc]

\end{document}
