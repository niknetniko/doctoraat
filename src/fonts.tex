\usepackage{fontspec}
\setmainfont{Source Serif 4}[
    Renderer = OpenType,
    SizeFeatures    = {%
        {Size={-9},Font=* Caption},
        {Size={9-13},Font=*},
        {Size={14-24},Font=* Subhead},
        {Size={24-},Font=* Display}
    },
    ItalicFeatures = {%
    SizeFeatures    = {%
            {Size={-9},Font=* Caption Italic},
            {Size={9-13},Font=* Italic},
            {Size={14-24},Font=* Subhead Italic},
            {Size={24-},Font=* Display Italic}
    },
    },
    BoldFeatures = {%
    SizeFeatures    = {%
            {Size={-9},Font=* Caption Semibold},
            {Size={9-13},Font=* Semibold},
            {Size={14-24},Font=* Subhead Semibold},
            {Size={24-},Font=* Display Semibold}
    },
    },
    BoldItalicFeatures = {%
    SizeFeatures    = {%
            {Size={-9},Font=* Caption Semibold Italic},
            {Size={9-13},Font=* Semibold Italic},
            {Size={14-24},Font=* Subhead Semibold Italic},
            {Size={24-},Font=* Display Semibold Italic}
    },
    },
    Numbers         = OldStyle,
]
\setsansfont{Source Sans 3}[
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
\setmonofont{Source Code Pro}[
    Scale          = MatchLowercase,
    UprightFont    = *-Regular,
    ItalicFont     = *-Italic,
    BoldFont       = *-Semibold,
    BoldItalicFont = *-Semibold Italic
]
% Have a math font that at least works with our choices.
%\usepackage{unicode-math}
%\setmathfont{Erewhon Math}

% Use real upper and lower scripts.
\usepackage{realscripts}
\usepackage{microtype}

% Stuff we want to be in small caps.
\usepackage{luacode}
\begin{luacode}
  to_replace = {
    {"TESTed", "\\textsc{test}ed"},
    "JSON",
    "YAML",
    "DSL",
    "API",
    "SVG",
    "NDJSON",
    "MIT",
    "GIL",
    "ABC",
    "ASCII",
    "IDE",
    "GUI",
    "FPS",
    "HTML",
    "CSS",
    "FTRPRF",
    "TIOBE",
    "SPOJ",
    "ACM-ICPC",
    "SQL",
    "ACM",
    "ICPC",
    "OSSL"
  }
  function capstosc(s)
    for _, needle in ipairs(to_replace) do
      if (type(needle) == "table") then
        replacement = needle[2]
        needle = needle[1]
      else
        replacement = "\\textsc{" .. string.lower(needle) .. "}"
      end
      pattern = "%f[%w_]" .. needle .. "%f[^%w_]"
      s = string.gsub(s, pattern, replacement)
    end
    return s
  end
\end{luacode}
\AtBeginDocument{%
    \directlua{luatexbase.add_to_callback ("process_input_buffer", capstosc, "capstosc" )}
}
