%! Suppress = MultipleIncludes
\documentclass[tikz]{standalone}

\onlyifstandalone{
    \usepackage[outputdir=../../out/]{minted}
    \setminted{autogobble=true}
}

\input{../tikz-preamble}

\begin{document}

\begin{tikzpicture}[x=0.75cm,y=0.75cm]
    \begin{scope} [shift={(0.625,1.5)}]
        \node[cont] at (0.75, -1.75) (ts1c1) {C\textsubscript{1}};
        \node[cont] at (2.25, -1.75) (ts1c2) {C\textsubscript{2}};
        \node[cont] at (3.75, -1.75) (ts1c3) {C\textsubscript{3}};
        \node[tc,minimum height=2\block,minimum width=4.5\block] at (0.5,-1) (tc1) {};
        \node[below right,text=ugent-ps] at (tc1.north west) {\small Unit 1};

        \node[cont] at (5.50, -1.75) (ts1c4) {C\textsubscript{4}};
        \node[cont] at (7.00, -1.75) (ts1c5) {C\textsubscript{5}};
        \node[tc,minimum height=2\block,minimum width=3\block] at (5.25,-1) (tc2) {};
        \node[below right,text=ugent-ps] at (tc2.north west) {\small Unit 2};

        \node[cont] at (8.75, -1.75) (ts1c6) {C\textsubscript{6}};
        \node[cont] at (10.25, -1.75) (ts1c7) {C\textsubscript{7}};
        \node[cont] at (11.75, -1.75) (ts1c8) {C\textsubscript{8}};
        \node[tc,minimum height=2\block,minimum width=4.5\block] at (8.5,-1) (tc3) {};
        \node[below right,text=ugent-ps] at (tc3.north west) {\small Unit 3};

        \node[comp,minimum height=2.5\block,minimum width=13\block] at (0.25,-0.75) (comp) {};

        \node[exec,minimum height=2.25\block,minimum width=4.25\block] at (0.625,-0.875) (execu1) {};
        \node[exec,minimum height=2.25\block,minimum width=1.25\block] at (5.375,-0.875) (execu2) {};
        \node[exec,minimum height=2.25\block,minimum width=6\block] at (6.875,-0.875) (execu3) {};
    \end{scope}

    \begin{scope} [shift={(0,-3)}]
        \node[document,minimum width=14.75\block, minimum height=9\block,draw=ugent-re] at (0,0) (executable) {};
        \node[below right,text=ugent-re] at (executable.north west) {\small Executable};

        \node[box,draw=ugent-re,minimum height=3.75\block,minimum width=3\block] at (0.25,-0.75) (main) {};
        \node[below right,text=ugent-re] at (main.north west) (mtitle) {\footnotesize\texttt{def main()}};
        \node[below right,text width=3\block] at (mtitle.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikzpython}
                match argument:
                  case "1":
                    exec1()
                  case "2":
                    exec2()
                  case "3":
                    exec3()
            \end{tikzpython}
        };

        \begin{scope} [shift={(-0.5,0)}]

            \node[exec,minimum height=3.75\block,minimum width=3.5\block] at (4,-0.75) (exec1) {};
            \node[below right,text=ugent-we] at (exec1.north west) (e1title) {\small \texttt{def exec1()}};
            \node[below right,text width=3.75\block] at (e1title.south west) {%
                \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
                \begin{tikzpython}
                    print_ctx_secret()
                    context1()
                    print_ctx_secret()
                    context2()
                    print_ctx_secret()
                    context3()
                \end{tikzpython}
            };

            \node[exec,minimum height=3.75\block,minimum width=3.5\block] at (7.75,-0.75) (exec2) {};
            \node[below right,text=ugent-we] at (exec2.north west) (e2title) {\small \texttt{def exec2()}};
            \node[below right,text width=3.75\block] at (e2title.south west) {%
                \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
                \begin{tikzpython}
                    print_ctx_secret()
                    context4()
                \end{tikzpython}
            };

            \node[exec,minimum height=3.75\block,minimum width=3.5\block] at (11.5,-0.75) (exec3) {};
            \node[below right,text=ugent-we] at (exec3.north west) (e3title) {\small \texttt{def exec3()}};
            \node[below right,text width=3.75\block] at (e3title.south west) {%
                \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
                \begin{tikzpython}
                    print_ctx_secret()
                    context5()
                    print_ctx_secret()
                    context6()
                    print_ctx_secret()
                    context7()
                    print_ctx_secret()
                    context8()
                \end{tikzpython}
            };

        \end{scope}

        % Normally, context functions should be here, however, they are drawn at the end.
    \end{scope}


    \draw[-latex,draw=ugent-we] (execu1) to [out=-90,in=90] (exec1);
    \draw[-latex,draw=ugent-we] (execu2) to [out=-90,in=90] (exec2);
    \draw[-latex,draw=ugent-we] (execu3) to [out=-90,in=90] (exec3);

    \draw[-latex,draw=ugent-re] (comp) -- (executable) node[midway,fill=white,fill opacity=0.8,text opacity=1] {\small Code generation and compilation};

    \begin{scope} [shift={(-0.25,-13.25)}]
        \node[document,draw=ugent-we,minimum width=4.25\block, minimum height=3.5\block] at (0.25, 0) (res1) {};
        \node[below right,color=ugent-we] at (res1.north west) (res1title) {\small \texttt{output1.txt}};
        \node[below right,text width=3.75\block] at (res1title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikztext}
                context_separator (C1)
                testcase_separator
                result1
                testcase_separator
                result2
            \end{tikztext}
        };

        \node[document,draw=ugent-we,minimum width=4.25\block, minimum height=3.5\block] at (5.5, 0) (res2) {};
        \node[below right,color=ugent-we] at (res2.north west) (res2title) {\small \texttt{output2.txt}};
        \node[below right,text width=3.75\block] at (res2title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikztext}
                context_separator (C1)
                testcase_separator
                result1
                context_separator (C2)
                testcase_separator
                result1
                ...
            \end{tikztext}
        };

        \node[document,draw=ugent-we,minimum width=4.25\block, minimum height=3.5\block] at (10.75, 0) (res3) {};
        \node[below right,color=ugent-we] at (res3.north west) (res3title) {\small \texttt{output3.txt}};
        \node[below right,text width=3.75\block] at (res3title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikztext}
                ...
                context_separator (C8)
                testcase_separator
                result1
            \end{tikztext}
        };
    \end{scope}

    \draw[-latex,draw=ugent-we] (exec1) to [out=-90,in=90] (res1);
    \draw[-latex,draw=ugent-we] (exec2) to [out=-90,in=90] (res2);
    \draw[-latex,draw=ugent-we] (exec3) to [out=-90,in=90] (res3);

    % Context functions, to be before the arrows
    \begin{scope} [shift={(0,-3.25)}]
        \node[cont,minimum width=4.25\block, minimum height=3.5\block,fill=white] at (0.25, -4.75) (cf1) {};
        \node[below right] at (cf1.north west) (c1title) {\small \texttt{def context1()}};
        \node[below right,text width=3.75\block] at (c1title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikzpython}
                print_tc_secret()
                testcase1()
                print_tc_secret()
                testcase2()
                print_tc_secret()
                testcase3()
                ...
            \end{tikzpython}
        };

        \node[cont,minimum width=4.25\block, minimum height=3.5\block,fill=white] at (4.75, -4.75) (cf2) {};
        \node[below right] at (cf2.north west) (c2title) {\small \texttt{def context2()}};
        \node[below right,text width=3.75\block] at (c2title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikzpython}
                print_tc_secret()
                testcase1()
                print_tc_secret()
                testcase2()
            \end{tikzpython}
        };

        \node[cont,draw opacity=0,align=center] at (9, -4.75) {\ldots};

        \node[cont,minimum width=4.25\block, minimum height=3.5\block,fill=white] at (10.25, -4.75) (cf8) {};
        \node[below right] at (cf8.north west) (c8title) {\small \texttt{def context8()}};
        \node[below right,text width=3.75\block] at (c8title.south west) {%
            \fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}%
            \begin{tikzpython}
                print_tc_secret()
                testcase1();
            \end{tikzpython}
        };
    \end{scope}

    \draw[draw opacity=0] (executable) -- (res2) node[midway,fill=white,fill opacity=0.8,text opacity=1] {\small Execution};

\end{tikzpicture}

\end{document}
